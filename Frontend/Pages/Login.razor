@page "/login"
@using System.ComponentModel.DataAnnotations
@using Frontend.Services
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject IJSRuntime JS

<div class="fullscreen-bg">
    <div class="login-card enhanced">
        <h2 class="login-title">Logowanie</h2>

        @if (!string.IsNullOrWhiteSpace(Error))
        {
            <p class="error">@Error</p>
        }

        <EditForm Model="@Model" OnValidSubmit="@LoginUser">
            <DataAnnotationsValidator />
            <ValidationSummary />

        <div class="input-wrapper">
            <i class="bi bi-envelope-fill input-icon"></i>
                <InputText class="input-field" @bind-Value="Model.Email" placeholder="Email" disabled="@IsLoading" />
        </div>
            <ValidationMessage For="@(() => Model.Email)" />

        <div class="input-wrapper">
            <i class="bi bi-lock-fill input-icon"></i>

            <input class="input-field"
                       @bind="Model.Password"
                   @bind:event="oninput"
                   placeholder="Hasło"
                   type="@(ShowPw ? "text" : "password")"
                   disabled="@IsLoading" />

            <button class="icon-btn"
                    type="button"
                    @onclick="TogglePw"
                    title="@(ShowPw ? "Ukryj hasło" : "Pokaż hasło")"
                    aria-label="@(ShowPw ? "Ukryj hasło" : "Pokaż hasło")">
                <i class="bi @(ShowPw ? "bi-eye-slash" : "bi-eye")"></i>
            </button>
        </div>
            <ValidationMessage For="@(() => Model.Password)" />

        <div class="auth-links left-align">
            <a href="/forgot-password">Zapomniałeś hasła?</a>
        </div>
        
            <button type="submit" class="btn login-btn" disabled="@IsLoading" aria-busy="@IsLoading">
            @if (IsLoading)
            {
                <span class="btn-spinner" aria-hidden="true"></span>
                <span>Logowanie...</span>
            }
            else
            {
                <span>Zaloguj się</span>
            }
        </button>
        </EditForm>
        
        <div class="google-btn-wrapper" style="margin-top: 0.75rem;">
            <div id="gsi_btn"></div>
        </div>

        <div class="auth-links center-row">
            <span>Nie masz konta?</span>
            <a href="/register" style="margin-left: 0.4rem;">Zarejestruj się</a>
        </div>
    </div>
</div>

@code {
    bool ShowPw;
    void TogglePw() => ShowPw = !ShowPw;

    string Error = "";
    bool IsLoading = false;

    private const string GoogleClientId = "628190551033-vgs07tcj28liadrpe05ajpfh7u083qga.apps.googleusercontent.com";
    private DotNetObjectReference<Login>? _dotNetRef;

    public class LoginModel
    {
        [Required(ErrorMessage = "Email jest wymagany.")]
        [EmailAddress(ErrorMessage = "Podaj poprawny email.")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Hasło jest wymagane.")]
        public string Password { get; set; } = "";
    }

    LoginModel Model = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
        if (!string.IsNullOrWhiteSpace(token) && !TokenGuard.IsExpired(token))
        {
            Navigation.NavigateTo("/panel", true);
            return;
        }

        if (!firstRender) return;
        _dotNetRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("googleAuth.init", GoogleClientId, _dotNetRef);
        await JS.InvokeVoidAsync("googleAuth.renderButton", "gsi_btn");
    }

    [JSInvokable]
    public async Task OnGoogleCredential(string credential)
    {
        var res = await AuthService.GoogleLogin(credential);
        if (res.Success)
        {
            Navigation.NavigateTo("/panel", true);
        }
        else
        {
            Error = res.Error ?? "Logowanie Google nie powiodło się.";
            StateHasChanged();
        }
    }

    private async Task LoginUser()
    {
        if (IsLoading) return;
        Error = "";
        IsLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var res = await AuthService.Login(Model.Email, Model.Password);
            if (!res.Success)
            {
                Error = res.Error ?? "Niepoprawne dane logowania.";
            }
            else
            {
                Navigation.NavigateTo("/panel");
            }
        }
        finally
        {
            IsLoading = false;
        }
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }
}
